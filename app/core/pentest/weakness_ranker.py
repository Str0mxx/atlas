"""
Zafiyet sıralayıcı modülü.

CVSS puanlama, istismar edilebilirlik,
iş etkisi, önceliklendirme.
"""

import logging
from datetime import datetime, timezone
from typing import Any
from uuid import uuid4

logger = logging.getLogger(__name__)


class WeaknessRanker:
    """Zafiyet sıralayıcı.

    Attributes:
        _weaknesses: Zafiyet kayitlari.
        _rankings: Siralama kayitlari.
        _stats: Istatistikler.
    """

    SEVERITY_LEVELS: list[str] = [
        "info",
        "low",
        "medium",
        "high",
        "critical",
    ]

    EXPLOITABILITY: list[str] = [
        "none",
        "theoretical",
        "proof_of_concept",
        "functional",
        "weaponized",
    ]

    BUSINESS_IMPACTS: list[str] = [
        "none",
        "minimal",
        "moderate",
        "significant",
        "catastrophic",
    ]

    def __init__(self) -> None:
        """Siralayiciyi baslatir."""
        self._weaknesses: dict[
            str, dict
        ] = {}
        self._rankings: list[dict] = []
        self._stats: dict[str, int] = {
            "weaknesses_added": 0,
            "rankings_generated": 0,
            "critical_count": 0,
            "high_count": 0,
        }
        logger.info(
            "WeaknessRanker baslatildi"
        )

    @property
    def weakness_count(self) -> int:
        """Zafiyet sayisi."""
        return len(self._weaknesses)

    def add_weakness(
        self,
        name: str = "",
        category: str = "",
        severity: str = "medium",
        exploitability: str = "theoretical",
        business_impact: str = "moderate",
        cve: str = "",
        affected_asset: str = "",
        description: str = "",
    ) -> dict[str, Any]:
        """Zafiyet ekler.

        Args:
            name: Zafiyet adi.
            category: Kategori.
            severity: Ciddiyet.
            exploitability: Istismar edilebilirlik.
            business_impact: Is etkisi.
            cve: CVE numarasi.
            affected_asset: Etkilenen varlik.
            description: Aciklama.

        Returns:
            Zafiyet bilgisi.
        """
        try:
            if (
                severity
                not in self.SEVERITY_LEVELS
            ):
                return {
                    "added": False,
                    "error": (
                        f"Gecersiz: {severity}"
                    ),
                }

            wid = f"wk_{uuid4()!s:.8}"
            cvss = self._calculate_cvss(
                severity,
                exploitability,
                business_impact,
            )

            self._weaknesses[wid] = {
                "weakness_id": wid,
                "name": name,
                "category": category,
                "severity": severity,
                "exploitability": (
                    exploitability
                ),
                "business_impact": (
                    business_impact
                ),
                "cve": cve,
                "affected_asset": (
                    affected_asset
                ),
                "description": description,
                "cvss_score": cvss,
                "status": "open",
                "added_at": datetime.now(
                    timezone.utc
                ).isoformat(),
            }
            self._stats[
                "weaknesses_added"
            ] += 1

            if severity == "critical":
                self._stats[
                    "critical_count"
                ] += 1
            elif severity == "high":
                self._stats[
                    "high_count"
                ] += 1

            return {
                "weakness_id": wid,
                "name": name,
                "cvss_score": cvss,
                "added": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "added": False,
                "error": str(e),
            }

    def _calculate_cvss(
        self,
        severity: str,
        exploitability: str,
        business_impact: str,
    ) -> float:
        """CVSS puani hesaplar."""
        sev_scores = {
            "info": 0.0,
            "low": 2.0,
            "medium": 5.0,
            "high": 7.5,
            "critical": 9.5,
        }
        exp_mult = {
            "none": 0.0,
            "theoretical": 0.5,
            "proof_of_concept": 0.7,
            "functional": 0.9,
            "weaponized": 1.0,
        }
        biz_mult = {
            "none": 0.0,
            "minimal": 0.3,
            "moderate": 0.6,
            "significant": 0.8,
            "catastrophic": 1.0,
        }

        base = sev_scores.get(severity, 5.0)
        exp = exp_mult.get(
            exploitability, 0.5
        )
        biz = biz_mult.get(
            business_impact, 0.6
        )

        score = base * 0.5 + (
            base * exp * 0.3
        ) + (base * biz * 0.2)
        return round(
            min(10.0, max(0.0, score)), 1
        )

    def rank_weaknesses(
        self,
    ) -> dict[str, Any]:
        """Zafiyetleri siralar.

        Returns:
            Siralama bilgisi.
        """
        try:
            open_w = [
                w
                for w in (
                    self._weaknesses.values()
                )
                if w["status"] == "open"
            ]

            ranked = sorted(
                open_w,
                key=lambda x: x[
                    "cvss_score"
                ],
                reverse=True,
            )

            ranking = {
                "ranking_id": (
                    f"rk_{uuid4()!s:.8}"
                ),
                "total": len(ranked),
                "ranked_at": datetime.now(
                    timezone.utc
                ).isoformat(),
                "items": [
                    {
                        "rank": i + 1,
                        "weakness_id": w[
                            "weakness_id"
                        ],
                        "name": w["name"],
                        "cvss_score": w[
                            "cvss_score"
                        ],
                        "severity": w[
                            "severity"
                        ],
                    }
                    for i, w in enumerate(
                        ranked
                    )
                ],
            }
            self._rankings.append(ranking)
            self._stats[
                "rankings_generated"
            ] += 1

            return {
                "total": len(ranked),
                "top_items": ranking[
                    "items"
                ][:5],
                "ranked": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "ranked": False,
                "error": str(e),
            }

    def get_by_severity(
        self,
        severity: str = "critical",
    ) -> dict[str, Any]:
        """Ciddiyete gore filtreler.

        Args:
            severity: Ciddiyet seviyesi.

        Returns:
            Filtrelenmis liste.
        """
        try:
            filtered = [
                {
                    "weakness_id": w[
                        "weakness_id"
                    ],
                    "name": w["name"],
                    "cvss_score": w[
                        "cvss_score"
                    ],
                }
                for w in (
                    self._weaknesses.values()
                )
                if w["severity"] == severity
                and w["status"] == "open"
            ]

            return {
                "severity": severity,
                "count": len(filtered),
                "items": filtered,
                "retrieved": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "retrieved": False,
                "error": str(e),
            }

    def close_weakness(
        self,
        weakness_id: str = "",
        resolution: str = "",
    ) -> dict[str, Any]:
        """Zafiyeti kapatir.

        Args:
            weakness_id: Zafiyet ID.
            resolution: Cozum aciklamasi.

        Returns:
            Kapatma bilgisi.
        """
        try:
            w = self._weaknesses.get(
                weakness_id
            )
            if not w:
                return {
                    "closed": False,
                    "error": (
                        "Zafiyet bulunamadi"
                    ),
                }

            w["status"] = "closed"
            w["resolution"] = resolution
            w["closed_at"] = datetime.now(
                timezone.utc
            ).isoformat()

            return {
                "weakness_id": weakness_id,
                "closed": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "closed": False,
                "error": str(e),
            }

    def get_summary(
        self,
    ) -> dict[str, Any]:
        """Ozet getirir."""
        try:
            open_c = sum(
                1
                for w in (
                    self._weaknesses.values()
                )
                if w["status"] == "open"
            )
            return {
                "total_weaknesses": len(
                    self._weaknesses
                ),
                "open_weaknesses": open_c,
                "total_rankings": len(
                    self._rankings
                ),
                "stats": dict(self._stats),
                "retrieved": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "retrieved": False,
                "error": str(e),
            }
