"""
Saldiri yuzeyi haritacisi modulu.

Yuzey haritalama, giris noktalari,
varlik kesfetme, maruziyet analizi,
risk gorsellestirme.
"""

import logging
from datetime import datetime, timezone
from typing import Any
from uuid import uuid4

logger = logging.getLogger(__name__)


class AttackSurfaceMapper:
    """Saldiri yuzeyi haritacisi.

    Attributes:
        _assets: Varlik kayitlari.
        _entry_points: Giris noktalari.
        _exposures: Maruziyet kayitlari.
        _maps: Harita kayitlari.
        _stats: Istatistikler.
    """

    ASSET_TYPES: list[str] = [
        "web_app",
        "api",
        "database",
        "server",
        "network",
        "cloud_service",
        "mobile_app",
        "iot_device",
    ]

    EXPOSURE_LEVELS: list[str] = [
        "none",
        "low",
        "medium",
        "high",
        "critical",
    ]

    def __init__(self) -> None:
        """Haritaciyi baslatir."""
        self._assets: dict[
            str, dict
        ] = {}
        self._entry_points: dict[
            str, dict
        ] = {}
        self._exposures: list[dict] = []
        self._maps: list[dict] = []
        self._stats: dict[str, int] = {
            "assets_discovered": 0,
            "entry_points_found": 0,
            "exposures_analyzed": 0,
            "maps_generated": 0,
        }
        logger.info(
            "AttackSurfaceMapper "
            "baslatildi"
        )

    @property
    def asset_count(self) -> int:
        """Varlik sayisi."""
        return len(self._assets)

    def discover_asset(
        self,
        name: str = "",
        asset_type: str = "web_app",
        host: str = "",
        port: int = 0,
        technology: str = "",
        owner: str = "",
        is_external: bool = True,
    ) -> dict[str, Any]:
        """Varlik kesfeder.

        Args:
            name: Varlik adi.
            asset_type: Varlik tipi.
            host: Sunucu.
            port: Port.
            technology: Teknoloji.
            owner: Sahip.
            is_external: Dis erisim.

        Returns:
            Varlik bilgisi.
        """
        try:
            if (
                asset_type
                not in self.ASSET_TYPES
            ):
                return {
                    "discovered": False,
                    "error": (
                        f"Gecersiz: "
                        f"{asset_type}"
                    ),
                }

            aid = f"as_{uuid4()!s:.8}"
            self._assets[aid] = {
                "asset_id": aid,
                "name": name,
                "asset_type": asset_type,
                "host": host,
                "port": port,
                "technology": technology,
                "owner": owner,
                "is_external": is_external,
                "status": "active",
                "discovered_at": (
                    datetime.now(
                        timezone.utc
                    ).isoformat()
                ),
            }
            self._stats[
                "assets_discovered"
            ] += 1

            return {
                "asset_id": aid,
                "name": name,
                "asset_type": asset_type,
                "discovered": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "discovered": False,
                "error": str(e),
            }

    def add_entry_point(
        self,
        asset_id: str = "",
        name: str = "",
        protocol: str = "",
        endpoint: str = "",
        auth_required: bool = False,
        description: str = "",
    ) -> dict[str, Any]:
        """Giris noktasi ekler.

        Args:
            asset_id: Varlik ID.
            name: Nokta adi.
            protocol: Protokol.
            endpoint: UÃ§ nokta.
            auth_required: Kimlik gerekli.
            description: Aciklama.

        Returns:
            Giris noktasi bilgisi.
        """
        try:
            asset = self._assets.get(
                asset_id
            )
            if not asset:
                return {
                    "added": False,
                    "error": (
                        "Varlik bulunamadi"
                    ),
                }

            eid = f"ep_{uuid4()!s:.8}"
            self._entry_points[eid] = {
                "entry_point_id": eid,
                "asset_id": asset_id,
                "name": name,
                "protocol": protocol,
                "endpoint": endpoint,
                "auth_required": (
                    auth_required
                ),
                "description": description,
                "added_at": datetime.now(
                    timezone.utc
                ).isoformat(),
            }
            self._stats[
                "entry_points_found"
            ] += 1

            return {
                "entry_point_id": eid,
                "asset_id": asset_id,
                "added": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "added": False,
                "error": str(e),
            }

    def analyze_exposure(
        self,
        asset_id: str = "",
    ) -> dict[str, Any]:
        """Maruziyet analizi yapar.

        Args:
            asset_id: Varlik ID.

        Returns:
            Maruziyet bilgisi.
        """
        try:
            asset = self._assets.get(
                asset_id
            )
            if not asset:
                return {
                    "analyzed": False,
                    "error": (
                        "Varlik bulunamadi"
                    ),
                }

            # Giris noktalarini say
            eps = [
                ep
                for ep in (
                    self._entry_points
                    .values()
                )
                if ep["asset_id"]
                == asset_id
            ]
            unauth_eps = [
                ep
                for ep in eps
                if not ep["auth_required"]
            ]

            # Maruziyet puani
            score = 0.0
            if asset["is_external"]:
                score += 0.3
            if len(eps) > 3:
                score += 0.2
            if unauth_eps:
                score += 0.3
            if asset["port"] in (
                22, 3306, 5432, 27017,
            ):
                score += 0.2

            score = round(
                min(1.0, score), 2
            )
            level = "none"
            if score >= 0.8:
                level = "critical"
            elif score >= 0.6:
                level = "high"
            elif score >= 0.4:
                level = "medium"
            elif score > 0.0:
                level = "low"

            exposure = {
                "asset_id": asset_id,
                "entry_points": len(eps),
                "unauth_points": len(
                    unauth_eps
                ),
                "exposure_score": score,
                "exposure_level": level,
                "is_external": asset[
                    "is_external"
                ],
                "analyzed_at": (
                    datetime.now(
                        timezone.utc
                    ).isoformat()
                ),
            }
            self._exposures.append(
                exposure
            )
            self._stats[
                "exposures_analyzed"
            ] += 1

            return {
                "asset_id": asset_id,
                "exposure_score": score,
                "exposure_level": level,
                "entry_points": len(eps),
                "analyzed": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "analyzed": False,
                "error": str(e),
            }

    def generate_map(
        self,
    ) -> dict[str, Any]:
        """Saldiri yuzeyi haritasi uretir.

        Returns:
            Harita bilgisi.
        """
        try:
            assets_data = []
            for a in self._assets.values():
                aid = a["asset_id"]
                eps = [
                    ep
                    for ep in (
                        self._entry_points
                        .values()
                    )
                    if ep["asset_id"] == aid
                ]
                assets_data.append({
                    "asset_id": aid,
                    "name": a["name"],
                    "type": a["asset_type"],
                    "is_external": a[
                        "is_external"
                    ],
                    "entry_points": len(
                        eps
                    ),
                })

            ext_count = sum(
                1
                for a in (
                    self._assets.values()
                )
                if a["is_external"]
            )

            map_data = {
                "map_id": (
                    f"mp_{uuid4()!s:.8}"
                ),
                "total_assets": len(
                    self._assets
                ),
                "external_assets": (
                    ext_count
                ),
                "total_entry_points": len(
                    self._entry_points
                ),
                "assets": assets_data,
                "generated_at": (
                    datetime.now(
                        timezone.utc
                    ).isoformat()
                ),
            }
            self._maps.append(map_data)
            self._stats[
                "maps_generated"
            ] += 1

            return {
                "total_assets": len(
                    self._assets
                ),
                "external_assets": (
                    ext_count
                ),
                "total_entry_points": len(
                    self._entry_points
                ),
                "generated": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "generated": False,
                "error": str(e),
            }

    def get_summary(
        self,
    ) -> dict[str, Any]:
        """Ozet getirir."""
        try:
            return {
                "total_assets": len(
                    self._assets
                ),
                "total_entry_points": len(
                    self._entry_points
                ),
                "total_exposures": len(
                    self._exposures
                ),
                "total_maps": len(
                    self._maps
                ),
                "stats": dict(self._stats),
                "retrieved": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "retrieved": False,
                "error": str(e),
            }
