"""
Sizma testi orkestratoru modulu.

Tam sizma testi, Tara -> Istismar ->
Sirala -> Duzelt pipeline, kirmizi
takim operasyonlari, analitik.
"""

import logging
from typing import Any

from .attack_surface_mapper import (
    AttackSurfaceMapper,
)
from .auto_pen_tester import (
    AutoPenTester,
)
from .exploit_simulator import (
    ExploitSimulator,
)
from .red_team_scheduler import (
    RedTeamScheduler,
)
from .remediation_planner import (
    RemediationPlanner,
)
from .security_scorecard import (
    SecurityScorecard,
)
from .social_engineering_tester import (
    SocialEngineeringTester,
)
from .weakness_ranker import (
    WeaknessRanker,
)

logger = logging.getLogger(__name__)


class PentestOrchestrator:
    """Sizma testi orkestratoru.

    Attributes:
        pen_tester: Otomatik testci.
        exploit_sim: Istismar simulatoru.
        social_tester: Sosyal muhendislik.
        weakness_ranker: Zafiyet sıralayıcı.
        remediation: Duzeltme planlayici.
        surface_mapper: Yuzey haritacisi.
        red_team: Kirmizi takim.
        scorecard: Puan karti.
    """

    def __init__(
        self,
        safe_mode: bool = True,
    ) -> None:
        """Orkestratoru baslatir.

        Args:
            safe_mode: Guvenli mod.
        """
        self._safe_mode = safe_mode
        self.pen_tester = AutoPenTester(
            safe_mode=safe_mode,
        )
        self.exploit_sim = (
            ExploitSimulator(
                safe_mode=safe_mode,
            )
        )
        self.social_tester = (
            SocialEngineeringTester()
        )
        self.weakness_ranker = (
            WeaknessRanker()
        )
        self.remediation = (
            RemediationPlanner()
        )
        self.surface_mapper = (
            AttackSurfaceMapper()
        )
        self.red_team = RedTeamScheduler()
        self.scorecard = (
            SecurityScorecard()
        )
        logger.info(
            "PentestOrchestrator "
            "baslatildi"
        )

    def run_full_scan(
        self,
        target: str = "",
        scenario: str = "comprehensive",
    ) -> dict[str, Any]:
        """Tam tarama calistirir.

        Scan -> Exploit -> Rank pipeline.

        Args:
            target: Hedef.
            scenario: Senaryo adi.

        Returns:
            Tarama sonucu.
        """
        try:
            # 1. Varlik kesfet
            asset = (
                self.surface_mapper
                .discover_asset(
                    name=target,
                    asset_type="web_app",
                    host=target,
                )
            )
            asset_id = asset.get(
                "asset_id", ""
            )

            # 2. Senaryo calistir
            scan = (
                self.pen_tester
                .run_scenario(
                    scenario_name=scenario,
                    target=target,
                )
            )

            # 3. Bulgulari zafiyet olarak
            # ekle ve sirala
            total_findings = scan.get(
                "total_findings", 0
            )
            for r in scan.get(
                "results", []
            ):
                if r.get("completed"):
                    test_type = r.get(
                        "test_type", ""
                    )
                    self.weakness_ranker\
                        .add_weakness(
                        name=(
                            f"{test_type}"
                            f"_finding"
                        ),
                        category=test_type,
                        severity=(
                            "high"
                            if r.get(
                                "findings", 0
                            ) > 0
                            else "low"
                        ),
                    )

            ranking = (
                self.weakness_ranker
                .rank_weaknesses()
            )

            # 4. Maruziyet analizi
            exposure = (
                self.surface_mapper
                .analyze_exposure(
                    asset_id=asset_id,
                )
            )

            return {
                "target": target,
                "scenario": scenario,
                "total_findings": (
                    total_findings
                ),
                "weaknesses_ranked": (
                    ranking.get("total", 0)
                ),
                "exposure_score": (
                    exposure.get(
                        "exposure_score",
                        0.0,
                    )
                ),
                "scan_completed": scan.get(
                    "completed", False
                ),
                "completed": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "completed": False,
                "error": str(e),
            }

    def simulate_exploit(
        self,
        exploit_name: str = "",
        target: str = "",
    ) -> dict[str, Any]:
        """Istismar simule eder.

        Args:
            exploit_name: Istismar adi.
            target: Hedef.

        Returns:
            Simulasyon sonucu.
        """
        try:
            sim = self.exploit_sim.simulate(
                exploit_name=exploit_name,
                target=target,
            )

            impact = None
            if sim.get("simulated"):
                sid = sim.get(
                    "simulation_id", ""
                )
                impact = (
                    self.exploit_sim
                    .assess_impact(
                        simulation_id=sid,
                    )
                )

            return {
                "exploit_name": (
                    exploit_name
                ),
                "target": target,
                "success": sim.get(
                    "success", False
                ),
                "impact": (
                    impact.get(
                        "impact_score", 0.0
                    )
                    if impact
                    else 0.0
                ),
                "simulated": sim.get(
                    "simulated", False
                ),
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "simulated": False,
                "error": str(e),
            }

    def plan_remediation(
        self,
        weakness_name: str = "",
        priority: str = "p2_high",
        team: str = "",
    ) -> dict[str, Any]:
        """Duzeltme planlar.

        Args:
            weakness_name: Zafiyet adi.
            priority: Oncelik.
            team: Takim.

        Returns:
            Plan bilgisi.
        """
        try:
            plan = (
                self.remediation
                .create_plan(
                    weakness_id=(
                        weakness_name
                    ),
                    name=(
                        f"Fix: "
                        f"{weakness_name}"
                    ),
                    priority=priority,
                    assigned_team=team,
                )
            )

            return {
                "plan_id": plan.get(
                    "plan_id", ""
                ),
                "weakness": weakness_name,
                "priority": priority,
                "planned": plan.get(
                    "created", False
                ),
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "planned": False,
                "error": str(e),
            }

    def run_social_engineering(
        self,
        campaign_name: str = "",
        attack_type: str = (
            "phishing_email"
        ),
        targets: (
            list[dict] | None
        ) = None,
    ) -> dict[str, Any]:
        """Sosyal muhendislik testi.

        Args:
            campaign_name: Kampanya adi.
            attack_type: Saldiri tipi.
            targets: Hedef listesi.

        Returns:
            Test sonucu.
        """
        try:
            # 1. Kampanya olustur
            camp = (
                self.social_tester
                .create_campaign(
                    name=campaign_name,
                    attack_type=attack_type,
                )
            )
            if not camp.get("created"):
                return {
                    "completed": False,
                    "error": camp.get(
                        "error", "Hata"
                    ),
                }

            cid = camp["campaign_id"]

            # 2. Hedefleri ekle
            added = 0
            for t in (targets or []):
                r = (
                    self.social_tester
                    .add_target(
                        campaign_id=cid,
                        user_id=t.get(
                            "user_id", ""
                        ),
                        email=t.get(
                            "email", ""
                        ),
                    )
                )
                if r.get("added"):
                    added += 1

            # 3. Test gonder
            sent = (
                self.social_tester
                .send_test(
                    campaign_id=cid,
                )
            )

            return {
                "campaign_id": cid,
                "targets_added": added,
                "targets_sent": sent.get(
                    "targets_sent", 0
                ),
                "completed": sent.get(
                    "sent", False
                ),
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "completed": False,
                "error": str(e),
            }

    def update_scorecard(
        self,
        category: str = "",
        score: float = 0.0,
        findings: int = 0,
    ) -> dict[str, Any]:
        """Puan kartini gunceller.

        Args:
            category: Kategori.
            score: Puan.
            findings: Bulgu sayisi.

        Returns:
            Guncelleme bilgisi.
        """
        try:
            r = (
                self.scorecard
                .assess_category(
                    category=category,
                    score=score,
                    findings=findings,
                )
            )

            return {
                "category": category,
                "score": score,
                "grade": r.get(
                    "grade", ""
                ),
                "overall_score": (
                    self.scorecard
                    .overall_score
                ),
                "updated": r.get(
                    "assessed", False
                ),
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "updated": False,
                "error": str(e),
            }

    def get_analytics(
        self,
    ) -> dict[str, Any]:
        """Analitik getirir."""
        try:
            pen_summary = (
                self.pen_tester
                .get_summary()
            )
            exploit_summary = (
                self.exploit_sim
                .get_summary()
            )
            weakness_summary = (
                self.weakness_ranker
                .get_summary()
            )
            surface_summary = (
                self.surface_mapper
                .get_summary()
            )
            scorecard_data = (
                self.scorecard
                .get_scorecard()
            )

            return {
                "pen_tests": (
                    pen_summary.get(
                        "stats", {}
                    )
                ),
                "exploits": (
                    exploit_summary.get(
                        "stats", {}
                    )
                ),
                "weaknesses": {
                    "total": (
                        weakness_summary.get(
                            "total_"
                            "weaknesses", 0
                        )
                    ),
                    "open": (
                        weakness_summary.get(
                            "open_"
                            "weaknesses", 0
                        )
                    ),
                },
                "surface": {
                    "assets": (
                        surface_summary.get(
                            "total_assets",
                            0,
                        )
                    ),
                    "entry_points": (
                        surface_summary.get(
                            "total_entry_"
                            "points", 0
                        )
                    ),
                },
                "scorecard": {
                    "overall": (
                        scorecard_data.get(
                            "overall_score",
                            0.0,
                        )
                    ),
                    "grade": (
                        scorecard_data.get(
                            "overall_grade",
                            "F",
                        )
                    ),
                },
                "retrieved": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "retrieved": False,
                "error": str(e),
            }

    def get_summary(
        self,
    ) -> dict[str, Any]:
        """Ozet getirir."""
        try:
            return {
                "safe_mode": (
                    self._safe_mode
                ),
                "pen_tester": (
                    self.pen_tester
                    .get_summary()
                ),
                "exploit_sim": (
                    self.exploit_sim
                    .get_summary()
                ),
                "social_tester": (
                    self.social_tester
                    .get_summary()
                ),
                "weakness_ranker": (
                    self.weakness_ranker
                    .get_summary()
                ),
                "remediation": (
                    self.remediation
                    .get_summary()
                ),
                "surface_mapper": (
                    self.surface_mapper
                    .get_summary()
                ),
                "red_team": (
                    self.red_team
                    .get_summary()
                ),
                "scorecard": (
                    self.scorecard
                    .get_summary()
                ),
                "retrieved": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "retrieved": False,
                "error": str(e),
            }
