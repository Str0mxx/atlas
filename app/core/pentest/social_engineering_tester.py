"""
Sosyal muhendislik testcisi modulu.

Phishing simulasyonu, pretexting
testleri, farkindalik puanlama,
egitim tetikleme, raporlama.
"""

import logging
from datetime import datetime, timezone
from typing import Any
from uuid import uuid4

logger = logging.getLogger(__name__)


class SocialEngineeringTester:
    """Sosyal muhendislik testcisi.

    Attributes:
        _campaigns: Kampanya kayitlari.
        _targets: Hedef kayitlari.
        _results: Sonuc kayitlari.
        _trainings: Egitim kayitlari.
        _stats: Istatistikler.
    """

    ATTACK_TYPES: list[str] = [
        "phishing_email",
        "spear_phishing",
        "pretexting",
        "baiting",
        "tailgating",
        "vishing",
        "smishing",
    ]

    ACTIONS: list[str] = [
        "opened",
        "clicked",
        "submitted_data",
        "reported",
        "ignored",
    ]

    def __init__(self) -> None:
        """Testciyi baslatir."""
        self._campaigns: dict[
            str, dict
        ] = {}
        self._targets: dict[
            str, dict
        ] = {}
        self._results: list[dict] = []
        self._trainings: list[dict] = []
        self._stats: dict[str, int] = {
            "campaigns_created": 0,
            "targets_added": 0,
            "tests_sent": 0,
            "clicked": 0,
            "reported": 0,
            "trainings_triggered": 0,
        }
        logger.info(
            "SocialEngineeringTester "
            "baslatildi"
        )

    @property
    def campaign_count(self) -> int:
        """Kampanya sayisi."""
        return len(self._campaigns)

    def create_campaign(
        self,
        name: str = "",
        attack_type: str = "phishing_email",
        description: str = "",
        template: str = "",
        difficulty: str = "medium",
    ) -> dict[str, Any]:
        """Kampanya olusturur.

        Args:
            name: Kampanya adi.
            attack_type: Saldiri tipi.
            description: Aciklama.
            template: Sablon.
            difficulty: Zorluk.

        Returns:
            Kampanya bilgisi.
        """
        try:
            if (
                attack_type
                not in self.ATTACK_TYPES
            ):
                return {
                    "created": False,
                    "error": (
                        f"Gecersiz: "
                        f"{attack_type}"
                    ),
                }

            cid = f"se_{uuid4()!s:.8}"
            self._campaigns[cid] = {
                "campaign_id": cid,
                "name": name,
                "attack_type": attack_type,
                "description": description,
                "template": template,
                "difficulty": difficulty,
                "status": "created",
                "targets": [],
                "created_at": datetime.now(
                    timezone.utc
                ).isoformat(),
            }
            self._stats[
                "campaigns_created"
            ] += 1

            return {
                "campaign_id": cid,
                "name": name,
                "created": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "created": False,
                "error": str(e),
            }

    def add_target(
        self,
        campaign_id: str = "",
        user_id: str = "",
        email: str = "",
        department: str = "",
        role: str = "",
    ) -> dict[str, Any]:
        """Hedef ekler.

        Args:
            campaign_id: Kampanya ID.
            user_id: Kullanici ID.
            email: E-posta.
            department: Departman.
            role: Rol.

        Returns:
            Hedef bilgisi.
        """
        try:
            campaign = self._campaigns.get(
                campaign_id
            )
            if not campaign:
                return {
                    "added": False,
                    "error": (
                        "Kampanya bulunamadi"
                    ),
                }

            tid = f"tg_{uuid4()!s:.8}"
            target = {
                "target_id": tid,
                "user_id": user_id,
                "email": email,
                "department": department,
                "role": role,
            }
            campaign["targets"].append(tid)
            self._targets[tid] = {
                **target,
                "campaign_id": campaign_id,
            }
            self._stats[
                "targets_added"
            ] += 1

            return {
                "target_id": tid,
                "campaign_id": campaign_id,
                "added": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "added": False,
                "error": str(e),
            }

    def send_test(
        self,
        campaign_id: str = "",
    ) -> dict[str, Any]:
        """Test gonderir (simulasyon).

        Args:
            campaign_id: Kampanya ID.

        Returns:
            Gonderim bilgisi.
        """
        try:
            campaign = self._campaigns.get(
                campaign_id
            )
            if not campaign:
                return {
                    "sent": False,
                    "error": (
                        "Kampanya bulunamadi"
                    ),
                }

            targets = campaign["targets"]
            if not targets:
                return {
                    "sent": False,
                    "error": (
                        "Hedef bulunamadi"
                    ),
                }

            campaign["status"] = "active"
            self._stats[
                "tests_sent"
            ] += len(targets)

            return {
                "campaign_id": campaign_id,
                "targets_sent": len(targets),
                "sent": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "sent": False,
                "error": str(e),
            }

    def record_action(
        self,
        campaign_id: str = "",
        target_id: str = "",
        action: str = "ignored",
    ) -> dict[str, Any]:
        """Hedef eylemini kaydeder.

        Args:
            campaign_id: Kampanya ID.
            target_id: Hedef ID.
            action: Eylem.

        Returns:
            Kayit bilgisi.
        """
        try:
            if (
                action
                not in self.ACTIONS
            ):
                return {
                    "recorded": False,
                    "error": (
                        f"Gecersiz: {action}"
                    ),
                }

            self._results.append({
                "campaign_id": campaign_id,
                "target_id": target_id,
                "action": action,
                "recorded_at": (
                    datetime.now(
                        timezone.utc
                    ).isoformat()
                ),
            })

            if action == "clicked":
                self._stats["clicked"] += 1
            elif action == "reported":
                self._stats["reported"] += 1

            # Veri giren hedefler icin
            # egitim tetikle
            if action == "submitted_data":
                self._stats["clicked"] += 1
                self._trigger_training(
                    target_id,
                    "data_submitted",
                )

            return {
                "campaign_id": campaign_id,
                "target_id": target_id,
                "action": action,
                "recorded": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "recorded": False,
                "error": str(e),
            }

    def _trigger_training(
        self,
        target_id: str,
        reason: str,
    ) -> None:
        """Egitim tetikler."""
        self._trainings.append({
            "training_id": (
                f"tr_{uuid4()!s:.8}"
            ),
            "target_id": target_id,
            "reason": reason,
            "triggered_at": datetime.now(
                timezone.utc
            ).isoformat(),
        })
        self._stats[
            "trainings_triggered"
        ] += 1

    def get_awareness_score(
        self,
        campaign_id: str = "",
    ) -> dict[str, Any]:
        """Farkindalik puani hesaplar.

        Args:
            campaign_id: Kampanya ID.

        Returns:
            Puan bilgisi.
        """
        try:
            campaign = self._campaigns.get(
                campaign_id
            )
            if not campaign:
                return {
                    "scored": False,
                    "error": (
                        "Kampanya bulunamadi"
                    ),
                }

            targets = campaign["targets"]
            if not targets:
                return {
                    "score": 0.0,
                    "scored": True,
                }

            results = [
                r
                for r in self._results
                if r["campaign_id"]
                == campaign_id
            ]

            reported = sum(
                1
                for r in results
                if r["action"] == "reported"
            )
            clicked = sum(
                1
                for r in results
                if r["action"] in (
                    "clicked",
                    "submitted_data",
                )
            )
            total = len(targets)

            # Puan: raporlayan +, tiklayan -
            score = 0.5
            if total > 0:
                report_rate = (
                    reported / total
                )
                click_rate = (
                    clicked / total
                )
                score = round(
                    max(
                        0.0,
                        min(
                            1.0,
                            0.5
                            + report_rate * 0.5
                            - click_rate * 0.5,
                        ),
                    ),
                    2,
                )

            return {
                "campaign_id": campaign_id,
                "score": score,
                "total_targets": total,
                "reported": reported,
                "clicked": clicked,
                "scored": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "scored": False,
                "error": str(e),
            }

    def get_summary(
        self,
    ) -> dict[str, Any]:
        """Ozet getirir."""
        try:
            return {
                "total_campaigns": len(
                    self._campaigns
                ),
                "total_targets": len(
                    self._targets
                ),
                "total_results": len(
                    self._results
                ),
                "total_trainings": len(
                    self._trainings
                ),
                "stats": dict(self._stats),
                "retrieved": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "retrieved": False,
                "error": str(e),
            }
