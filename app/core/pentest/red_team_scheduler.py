"""
Kirmizi takim zamanlayici modulu.

Tatbikat zamanlama, takim koordinasyonu,
senaryo yonetimi, catisma kurallari,
degerlendirme planlama.
"""

import logging
from datetime import datetime, timezone
from typing import Any
from uuid import uuid4

logger = logging.getLogger(__name__)


class RedTeamScheduler:
    """Kirmizi takim zamanlayici.

    Attributes:
        _exercises: Tatbikat kayitlari.
        _teams: Takim kayitlari.
        _rules: Catisma kurallari.
        _debriefs: Degerlendirmeler.
        _stats: Istatistikler.
    """

    EXERCISE_TYPES: list[str] = [
        "full_simulation",
        "tabletop",
        "purple_team",
        "assumed_breach",
        "physical",
        "social_engineering",
    ]

    EXERCISE_STATUSES: list[str] = [
        "planned",
        "active",
        "paused",
        "completed",
        "cancelled",
    ]

    def __init__(self) -> None:
        """Zamanlayiciyi baslatir."""
        self._exercises: dict[
            str, dict
        ] = {}
        self._teams: dict[
            str, dict
        ] = {}
        self._rules: dict[
            str, dict
        ] = {}
        self._debriefs: list[dict] = []
        self._stats: dict[str, int] = {
            "exercises_created": 0,
            "teams_registered": 0,
            "exercises_completed": 0,
            "debriefs_done": 0,
        }
        logger.info(
            "RedTeamScheduler "
            "baslatildi"
        )

    @property
    def exercise_count(self) -> int:
        """Tatbikat sayisi."""
        return len(self._exercises)

    def create_exercise(
        self,
        name: str = "",
        exercise_type: str = (
            "full_simulation"
        ),
        description: str = "",
        scope: str = "",
        start_date: str = "",
        end_date: str = "",
        objectives: list[str]
        | None = None,
    ) -> dict[str, Any]:
        """Tatbikat olusturur.

        Args:
            name: Tatbikat adi.
            exercise_type: Tip.
            description: Aciklama.
            scope: Kapsam.
            start_date: Baslangic tarihi.
            end_date: Bitis tarihi.
            objectives: Hedefler.

        Returns:
            Tatbikat bilgisi.
        """
        try:
            if (
                exercise_type
                not in self.EXERCISE_TYPES
            ):
                return {
                    "created": False,
                    "error": (
                        f"Gecersiz: "
                        f"{exercise_type}"
                    ),
                }

            eid = f"rx_{uuid4()!s:.8}"
            self._exercises[eid] = {
                "exercise_id": eid,
                "name": name,
                "exercise_type": (
                    exercise_type
                ),
                "description": description,
                "scope": scope,
                "start_date": start_date,
                "end_date": end_date,
                "objectives": (
                    objectives or []
                ),
                "status": "planned",
                "teams": [],
                "created_at": datetime.now(
                    timezone.utc
                ).isoformat(),
            }
            self._stats[
                "exercises_created"
            ] += 1

            return {
                "exercise_id": eid,
                "name": name,
                "created": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "created": False,
                "error": str(e),
            }

    def register_team(
        self,
        name: str = "",
        role: str = "red",
        members: list[str] | None = None,
        lead: str = "",
    ) -> dict[str, Any]:
        """Takim kaydeder.

        Args:
            name: Takim adi.
            role: Rol (red/blue/white).
            members: Uyeler.
            lead: Lider.

        Returns:
            Takim bilgisi.
        """
        try:
            tid = f"tm_{uuid4()!s:.8}"
            self._teams[tid] = {
                "team_id": tid,
                "name": name,
                "role": role,
                "members": members or [],
                "lead": lead,
                "registered_at": (
                    datetime.now(
                        timezone.utc
                    ).isoformat()
                ),
            }
            self._stats[
                "teams_registered"
            ] += 1

            return {
                "team_id": tid,
                "name": name,
                "role": role,
                "registered": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "registered": False,
                "error": str(e),
            }

    def assign_team(
        self,
        exercise_id: str = "",
        team_id: str = "",
    ) -> dict[str, Any]:
        """Takimi tatbikata atar.

        Args:
            exercise_id: Tatbikat ID.
            team_id: Takim ID.

        Returns:
            Atama bilgisi.
        """
        try:
            exercise = (
                self._exercises.get(
                    exercise_id
                )
            )
            if not exercise:
                return {
                    "assigned": False,
                    "error": (
                        "Tatbikat bulunamadi"
                    ),
                }

            team = self._teams.get(team_id)
            if not team:
                return {
                    "assigned": False,
                    "error": (
                        "Takim bulunamadi"
                    ),
                }

            if (
                team_id
                not in exercise["teams"]
            ):
                exercise["teams"].append(
                    team_id
                )

            return {
                "exercise_id": exercise_id,
                "team_id": team_id,
                "assigned": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "assigned": False,
                "error": str(e),
            }

    def set_rules_of_engagement(
        self,
        exercise_id: str = "",
        allowed_techniques: (
            list[str] | None
        ) = None,
        forbidden_actions: (
            list[str] | None
        ) = None,
        escalation_contact: str = "",
        time_restrictions: str = "",
    ) -> dict[str, Any]:
        """Catisma kurallari belirler.

        Args:
            exercise_id: Tatbikat ID.
            allowed_techniques: Izinli.
            forbidden_actions: Yasak.
            escalation_contact: Eskalasyon.
            time_restrictions: Zaman.

        Returns:
            Kural bilgisi.
        """
        try:
            exercise = (
                self._exercises.get(
                    exercise_id
                )
            )
            if not exercise:
                return {
                    "set": False,
                    "error": (
                        "Tatbikat bulunamadi"
                    ),
                }

            rid = f"rl_{uuid4()!s:.8}"
            self._rules[exercise_id] = {
                "rule_id": rid,
                "exercise_id": exercise_id,
                "allowed_techniques": (
                    allowed_techniques or []
                ),
                "forbidden_actions": (
                    forbidden_actions or []
                ),
                "escalation_contact": (
                    escalation_contact
                ),
                "time_restrictions": (
                    time_restrictions
                ),
                "set_at": datetime.now(
                    timezone.utc
                ).isoformat(),
            }

            return {
                "rule_id": rid,
                "exercise_id": exercise_id,
                "set": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "set": False,
                "error": str(e),
            }

    def update_exercise_status(
        self,
        exercise_id: str = "",
        status: str = "active",
    ) -> dict[str, Any]:
        """Tatbikat durumunu gunceller.

        Args:
            exercise_id: Tatbikat ID.
            status: Yeni durum.

        Returns:
            Guncelleme bilgisi.
        """
        try:
            exercise = (
                self._exercises.get(
                    exercise_id
                )
            )
            if not exercise:
                return {
                    "updated": False,
                    "error": (
                        "Tatbikat bulunamadi"
                    ),
                }

            if (
                status
                not in self.EXERCISE_STATUSES
            ):
                return {
                    "updated": False,
                    "error": (
                        f"Gecersiz: {status}"
                    ),
                }

            exercise["status"] = status
            if status == "completed":
                exercise["completed_at"] = (
                    datetime.now(
                        timezone.utc
                    ).isoformat()
                )
                self._stats[
                    "exercises_completed"
                ] += 1

            return {
                "exercise_id": exercise_id,
                "status": status,
                "updated": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "updated": False,
                "error": str(e),
            }

    def create_debrief(
        self,
        exercise_id: str = "",
        findings_count: int = 0,
        objectives_met: int = 0,
        lessons_learned: (
            list[str] | None
        ) = None,
        recommendations: (
            list[str] | None
        ) = None,
    ) -> dict[str, Any]:
        """Degerlendirme olusturur.

        Args:
            exercise_id: Tatbikat ID.
            findings_count: Bulgu sayisi.
            objectives_met: Karsilanan.
            lessons_learned: Dersler.
            recommendations: Oneriler.

        Returns:
            Degerlendirme bilgisi.
        """
        try:
            exercise = (
                self._exercises.get(
                    exercise_id
                )
            )
            if not exercise:
                return {
                    "created": False,
                    "error": (
                        "Tatbikat bulunamadi"
                    ),
                }

            did = f"db_{uuid4()!s:.8}"
            total_obj = len(
                exercise.get(
                    "objectives", []
                )
            )
            success_rate = (
                round(
                    objectives_met
                    / total_obj,
                    2,
                )
                if total_obj > 0
                else 0.0
            )

            debrief = {
                "debrief_id": did,
                "exercise_id": exercise_id,
                "findings_count": (
                    findings_count
                ),
                "objectives_met": (
                    objectives_met
                ),
                "total_objectives": (
                    total_obj
                ),
                "success_rate": (
                    success_rate
                ),
                "lessons_learned": (
                    lessons_learned or []
                ),
                "recommendations": (
                    recommendations or []
                ),
                "created_at": datetime.now(
                    timezone.utc
                ).isoformat(),
            }
            self._debriefs.append(debrief)
            self._stats[
                "debriefs_done"
            ] += 1

            return {
                "debrief_id": did,
                "success_rate": (
                    success_rate
                ),
                "created": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "created": False,
                "error": str(e),
            }

    def get_summary(
        self,
    ) -> dict[str, Any]:
        """Ozet getirir."""
        try:
            return {
                "total_exercises": len(
                    self._exercises
                ),
                "total_teams": len(
                    self._teams
                ),
                "total_rules": len(
                    self._rules
                ),
                "total_debriefs": len(
                    self._debriefs
                ),
                "stats": dict(self._stats),
                "retrieved": True,
            }

        except Exception as e:
            logger.error(f"Hata: {e}")
            return {
                "retrieved": False,
                "error": str(e),
            }
